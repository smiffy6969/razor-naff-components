<!--
* razor-naff-components
* naff-input - Form input with user feedback
* @author Paul Smith (smiffy6969)
* @site ulsmith.net
* @licence MIT
-->

<!-- DEPENDANCIES -->
<link rel="import" href="../../naff-base.html">

<!-- STYLE - Encapsulate all css to tag name -->
<style>
	naff-input .-input-group input { padding: 2px 5px; border: none; border-bottom: 2px solid #999; outline: none; font-size: 15px; }
	naff-input .-input-group input:focus:not([disabled]), naff-input .-input-group input:active:not([disabled]) { border-bottom-width: 3px; border-color: #777; }
	naff-input .-input-group input[disabled] { cursor: not-allowed; border-bottom: 2px dashed #999; background-color: #fff; }
	naff-input .-input-group input.error, naff-input .-input-group input.error:focus, naff-input .-input-group input.error:active { border-color: red; color: red; }
	naff-input .-input-group .-input-error { visibility: hidden; color: red; font-size: 10px; }
</style>

<!-- TEMPLATE --> 
<template id="naff-input">
	<div class="-input-group">
		<input>
		<div class="-input-error">
			<naff-icon name="warning"></naff-icon>
			<span class="-input-error-message"></span>
		</div>
	</div>
</template>

<!-- LOGIC -->
<script>
	// build scope
	naff.registerElement({
		name: 'naff-input',

		properties: { 
			error: null,
			value: null,
			validate: null,
			validateMessage: null 
		},

		created: function()
		{		
			// Initial setup
			if (this.host.hasAttribute('name')) this.template.querySelector('input').setAttribute('name', this.host.getAttribute('name'));
			if (this.host.hasAttribute('type')) this.template.querySelector('input').setAttribute('type', this.host.getAttribute('type'));
			if (this.host.hasAttribute('value')) this.template.querySelector('input').setAttribute('value', this.host.getAttribute('value'));
			if (this.host.hasAttribute('disabled')) this.template.querySelector('input').setAttribute('disabled', '');
			if (this.host.hasAttribute('placeholder')) this.template.querySelector('input').setAttribute('placeholder', this.host.getAttribute('placeholder'));
			if (this.host.hasAttribute('validate')) this.properties.validate = this.host.getAttribute('validate');
			if (this.host.hasAttribute('validateMessage')) 
			{
				this.properties.validateMessage = this.host.getAttribute('validateMessage');
				this.template.querySelector('.-input-error-message').innerText = this.properties.validateMessage;
			}
		},

		attached: function()
		{
			this.template.querySelector('input').addEventListener('input', this.onInputChanged);
			this.template.querySelector('input').addEventListener('keypress', this.onKeyPressed);
		},

		detached: function()
		{
			this.template.querySelector('input').removeEventListener('input', this.onInputChanged);
			this.template.querySelector('input').removeEventListener('keypress', this.onKeyPressed);
		},

		attributeChanged: function(name, oldVal, newVal)
		{
			switch (name)
			{
				case 'name': 
				case 'type': 
				case 'value': 
				case 'placeholder': 
					if (newVal) this.template.querySelector('input').setAttribute(name, newVal);
					else this.template.querySelector('input').removeAttribute(name);
				break;
				case 'disabled':
					if (newVal) this.template.querySelector('input').setAttribute('disabled', '');
					else this.template.querySelector('input').removeAttribute('disabled');
				break;
				case 'validate':
					this.properties[name] = newVal;
				break;
				case 'validateMessage':
					this.properties.validateMessage = newVal;
					this.template.querySelector('.-input-error-message').innerText = newVal;
				break;
			}
		},

		onInputChanged: function()
		{
			var scope = naff.getScope(this);
			scope.fire('change');
			scope.properties.value = this.value;
			scope.host.setAttribute('value', this.value);
			scope.checkError(this.value);
			scope.fire('changed');
		},

		onKeyPressed: function(event)
		{
			naff.getScope(this).fire('keypress', event);
		},

		checkError: function(value)
		{
			if (!this.properties.validate) return;

			// validate input
			var regexp = new RegExp(this.properties.validate);
			this.properties.error = regexp.test(value);

			if (this.properties.error) 
			{
				this.template.querySelector('.-input-error').style.visibility = 'hidden';
				this.host.removeAttribute('error');
			}
			else 
			{
				this.fire('error', this.properties.validateMessage);
				this.template.querySelector('.-input-error').style.visibility = 'visible';
				this.host.setAttribute('error', '');
			}
		}
	});
</script>